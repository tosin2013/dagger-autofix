name: Validate CI Setup

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/**'

jobs:
  validate-workflows:
    name: Validate Workflow Configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate YAML syntax
      run: |
        echo "ðŸ” Validating workflow YAML syntax..."
        
        for workflow in .github/workflows/*.yml; do
          if [ -f "$workflow" ]; then
            echo "Checking $workflow..."
            python3 -c "import yaml; yaml.safe_load(open('$workflow'))" || exit 1
            echo "âœ… $workflow is valid"
          fi
        done
        
        echo "âœ… All workflow files have valid YAML syntax"
    
    - name: Check workflow structure
      run: |
        echo "ðŸ“‹ Checking workflow structure..."
        
        # Check that required workflows exist
        required_workflows=("ci.yml" "pr-validation.yml")
        
        for workflow in "${required_workflows[@]}"; do
          if [ -f ".github/workflows/$workflow" ]; then
            echo "âœ… $workflow exists"
          else
            echo "âŒ $workflow is missing"
            exit 1
          fi
        done
        
        echo "âœ… All required workflows are present"
    
    - name: Validate workflow triggers
      run: |
        echo "ðŸŽ¯ Validating workflow triggers..."
        
        # Check CI workflow has correct triggers
        if grep -q "push:" .github/workflows/ci.yml && grep -q "pull_request:" .github/workflows/ci.yml; then
          echo "âœ… CI workflow has correct triggers"
        else
          echo "âŒ CI workflow missing required triggers"
          exit 1
        fi
        
        # Check PR validation workflow has correct triggers
        if grep -q "pull_request:" .github/workflows/pr-validation.yml; then
          echo "âœ… PR validation workflow has correct triggers"
        else
          echo "âŒ PR validation workflow missing required triggers"
          exit 1
        fi
        
        echo "âœ… Workflow triggers are correctly configured"
    
    - name: Summary
      run: |
        echo "## ðŸŽ‰ CI Setup Validation Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Validated Components:" >> $GITHUB_STEP_SUMMARY
        echo "- YAML syntax validation" >> $GITHUB_STEP_SUMMARY
        echo "- Required workflow files" >> $GITHUB_STEP_SUMMARY
        echo "- Workflow trigger configuration" >> $GITHUB_STEP_SUMMARY
        echo "- Directory structure" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Created Structure:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo ".github/" >> $GITHUB_STEP_SUMMARY
        echo "â””â”€â”€ workflows/" >> $GITHUB_STEP_SUMMARY
        echo "    â”œâ”€â”€ ci.yml" >> $GITHUB_STEP_SUMMARY
        echo "    â”œâ”€â”€ pr-validation.yml" >> $GITHUB_STEP_SUMMARY
        echo "    â”œâ”€â”€ validate-setup.yml" >> $GITHUB_STEP_SUMMARY
        echo "    â””â”€â”€ README.md" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **Ready for Task 2: Comprehensive test execution and coverage analysis**" >> $GITHUB_STEP_SUMMARY